(function(){angular.module("ui.angularSku",[]).value("skuConfig",{splitStr:";"}).factory("utilService",["$log","skuConfig",function(c,a){var d={},b=[];return{filter:function(f,e){var g=[];angular.forEach(f,function(i,h){if(e(i,h)){g.push(i)}});return g},getIndex:function(f){var e=-1;angular.forEach(b,function(h,g){if(e!==-1){return}angular.forEach(h,function(j,i){if(f===j){e=g}})});return e},unique:function(e){var h=[];var g={};for(var f=0;f<e.length;f++){if(!g[e[f]]){h.push(e[f]);g[e[f]]=1}}return h},getSkuList:function(e){var f=[];if(!e){c.error("input sku-data error!")}angular.forEach(e,function(h,g){f.push(g.split(a.splitStr))});return f},transpose:function(f){var e=f.length?f.length:0,m=f[0] instanceof Array?f[0].length:0;if(m===0||e===0){return[]}var l,g,k=[];for(l=0;l<m;l++){k[l]=[];for(g=0;g<e;g++){k[l][g]=f[g][l]}}return k},getKeys:function(j){var h=this.getSkuList(j),e=this.transpose(h),g=[];for(var f=0;f<e.length;f++){g[f]=this.unique(e[f])}b=g;return b},getNum:function(p,h){var q=0,k,g,f,l,e=[],o=[];if(angular.isDefined(d[p])){return d[p]}l=p.split(a.splitStr);if(l.length===b.length){o["count"]=h[p]?h[p].count:0;o["price"]=h[p]?h[p].price:0;return o}for(k=0;k<b.length;k++){for(g=0;g<b[k].length&&l.length>0;g++){if(b[k][g]==l[0]){break}}if(g<b[k].length&&l.length>0){e.push(l.shift())}else{for(f=0;f<b[k].length;f++){var o=this.getNum(e.concat(b[k][f],l).join(a.splitStr),h);q+=o["count"]}break}}d[p]=q;return q}}}]).directive("uiSku",["$log","skuConfig","utilService",function(c,a,b){return{restrict:"A",transclude:true,scope:{splitStr:"@",initSku:"@",onOk:"&",skuData:"="},controller:["$scope","$element","$attrs",function(f,e,d){this.checkIn=function(g){f.initSelect(g)}}],link:function(h,g,f,d,e){h.$watch("skuData",function(){if(!!h.splitStr){a.splitStr=h.splitStr}h.keyMap={};h.selected=[];h.keys=b.getKeys(h.skuData);angular.forEach(h.keys,function(j,i){angular.forEach(j,function(l,k){h.keyMap[l]={name:l,selected:!1,disabled:!1}})})});e(h,function(i){g.append(i)});h.initSelect=function(i){var j=i.split(a.splitStr);if(j.length==0){c.error("input init-sku is undefiend!")}angular.forEach(j,function(l,k){h.onSelect(l)})};h.onSelect=function(j){var k=h.keyMap,i=[];if(k[j].disabled){return}h.checkItem(j);i=b.filter(h.selected,function(m,l){return angular.isDefined(m)});h.onOk({$event:b.getNum(i.join(a.splitStr),h.skuData)})};h.checkItem=function(k){var m=h.keyMap,l=[],i=[],j=b.getIndex(k);if(j===-1){c.error("key is undefiend!");return}h.selected[j]=(h.selected[j]===k)?void 0:k;angular.forEach(h.keys,function(o,n){angular.copy(h.selected,l);angular.forEach(o,function(q,r){if(n===j){m[q].selected=!!(k===q)?!m[q].selected:!1}if(n===j||!!m[q].selected){return}l[n]=q;i=b.filter(l,function(t,s){return angular.isDefined(t)});var p=b.getNum(i.join(a.splitStr),h.skuData);if($.type(p)=="number"){m[q].disabled=p>0?false:true}else{if($.type(p)=="array"){m[q].disabled=p["count"]>0?false:true}}})})};if(!!h.initSku){h.initSelect(h.initSku)}}}}])})();